name: Contentful CI/CD Automation Workflow

on:
  workflow_dispatch:
    inputs:
      brand:
        description: 'Select brand (Contentful space) to deploy'
        required: true
        type: choice
        options:
          - Dev R&D
          - Fitness First
          - Goodlife Website
          - Gym Website
          - Jetts New Zealand
          - Zap Fitness
      base_env_name:
        description: 'Base environment name prefix (used for clone)'
        required: false
        default: master
      max_env_count:
        description: 'Max allowed environments (used for clone)'
        required: false
        default: 2
      source_env:
        description: 'Source environment (for alias update)'
        required: false
        default: 'master-v7'

env:
  CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
  CONTENTFUL_CDA_TOKEN: ${{ secrets.CONTENTFUL_CDA_TOKEN }}
  MASTER_ALIAS: master
  NODE_VERSION: 20

jobs:
  prepare-env:
    runs-on: ubuntu-latest
    outputs:
      CURRENT_MASTER_ENV: ${{ steps.set_env.outputs.current_master_env }}
      NEW_ENV: ${{ steps.set_env.outputs.new_env }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Contentful CLI
        run: npm install -g contentful-cli contentful-migration contentful-merge

      - name: Set SPACE_ID based on brand input
        id: set_space
        run: |
          case "${{ github.event.inputs.brand }}" in
            "Fitness First")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_FITNESS_FIRST }}" >> $GITHUB_ENV
              ;;
            "Dev R&D")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID }}" >> $GITHUB_ENV
              ;;
            "Goodlife Website")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_GOODLIFE_WEBSITE }}" >> $GITHUB_ENV
              ;;
            "Gym Website")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_GYM_WEBSITE }}" >> $GITHUB_ENV
              ;;
            "Jetts New Zealand")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_JETTS_NEW_ZEALAND }}" >> $GITHUB_ENV
              ;;
            "Zap Fitness")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_ZAP_FITNESS }}" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown brand '${{ github.event.inputs.brand }}'"
              exit 1
              ;;
          esac

      - name: Manage & clone environments
        id: set_env
        run: |
          base="${{ github.event.inputs.base_env_name }}"
          master_alias="${{ env.MASTER_ALIAS }}"
          max_env=${{ github.event.inputs.max_env_count }}

          # Get current master alias target environment
          alias_info=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            "https://api.contentful.com/spaces/$SPACE_ID/environment_aliases/$master_alias")
          current_master_env=$(echo "$alias_info" | jq -r '.environment.sys.id // "unknown"')
          echo "ðŸŸ¢ Current master alias points to environment: $current_master_env"
          echo "current_master_env=$current_master_env" >> $GITHUB_OUTPUT

          # Determine next version
          current_version=$(echo "$current_master_env" | grep -oE '[0-9]+$' || echo "0")
          next_version=$((current_version + 1))
          next_env_name="${base}-v${next_version}"
          echo "ðŸ§® Next eligible environment name: $next_env_name"
          echo "new_env=$next_env_name" >> $GITHUB_OUTPUT

          # Clone environment
          contentful space environment create \
            --space-id "$SPACE_ID" \
            --management-token "$CONTENTFUL_TOKEN" \
            --environment-id "$next_env_name" \
            --name "$next_env_name" \
            --source-environment "$current_master_env"

      - name: Lock master environment
        run: bash ./scripts/contentful-lock-master.sh "$SPACE_ID" "$CONTENTFUL_TOKEN"

      - name: Add new env to CDA key
        run: |
          CDA_KEY_ID=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            "https://api.contentful.com/spaces/$SPACE_ID/api_keys" \
            | jq -r '.items[] | select(.accessToken=="'${{ secrets.CONTENTFUL_CDA_TOKEN }}'") | .sys.id')

          CDA_KEY_DETAILS=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            "https://api.contentful.com/spaces/$SPACE_ID/api_keys/$CDA_KEY_ID")

          ENV_LIST=$(echo "$CDA_KEY_DETAILS" | jq '[.environments[].sys.id]')
          VERSION=$(echo "$CDA_KEY_DETAILS" | jq -r '.sys.version')
          UPDATED_ENVS=$(echo "$ENV_LIST" | jq --arg new "$NEW_ENV" '( . // [] ) | if index($new) then . else . + [$new] end')
          PAYLOAD=$(echo "$UPDATED_ENVS" | jq -c '{environments: [.[] | {sys: {type: "Link", linkType: "Environment", id: .}}]}')

          RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
            -X PUT \
            -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            -H "x-contentful-version: $VERSION" \
            -H "Content-Type: application/vnd.contentful.management.v1+json" \
            -d "$PAYLOAD" \
            "https://api.contentful.com/spaces/$SPACE_ID/api_keys/$CDA_KEY_ID")

          if [[ "$RESPONSE" -ne 200 ]]; then
            echo "Failed to update CDA key environments."
            exit 1
          fi

      - name: Wait for new environment to be ready
        run: |
          for i in {1..30}; do
            status=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
              "https://api.contentful.com/spaces/$SPACE_ID/environments/$NEW_ENV" | jq -r '.sys.status.sys.id')
            if [[ "$status" == "ready" ]]; then
              echo "Environment $NEW_ENV is ready."
              break
            fi
            sleep 10
          done

      - name: Run migration scripts
        run: |
          contentful-migration \
            --space-id "$SPACE_ID" \
            --access-token "$CONTENTFUL_TOKEN" \
            --environment-id "$NEW_ENV" \
            --yes \
            Migrations/index.js

      - name: Upload roles backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: contentful-roles-backup
          path: ./roles-backup.json
          retention-days: 7

  apply-changes:
    runs-on: ubuntu-latest
    needs: prepare-env
    environment: prod   # <-- GitHub will pause for approval here
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Contentful CLI
        run: npm install -g contentful-cli contentful-migration contentful-merge

      - name: Download roles backup artifact
        uses: actions/download-artifact@v4
        with:
          name: contentful-roles-backup
          path: .

      - name: Fetch latest target environment
        id: fetch_env
        run: |
          latest_env=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.contentful.com/spaces/$SPACE_ID/environments" \
            | jq -r '[.items[] | select(.name | test("^master-v[0-9]+$")) | {name: .name, createdAt: .sys.createdAt}] | sort_by(.createdAt) | last | .name')

          if [ -z "$latest_env" ] || [ "$latest_env" = "null" ]; then
            target_env="master"
          else
            target_env="$latest_env"
          fi

          echo "TARGET_ENV=$target_env" >> $GITHUB_ENV

      - name: Create changeset and check conflicts
        id: conflict-check
        run: |
          contentful-merge create \
            --cda-token "$CONTENTFUL_CDA_TOKEN" \
            --space "$SPACE_ID" \
            --source "${{ needs.prepare-env.outputs.CURRENT_MASTER_ENV }}" \
            --target "$TARGET_ENV" \
            --output-file changeset.json

          if grep -q '"conflicts":\s*\[' changeset.json && grep -qv '"conflicts":\s*\[\s*\]' changeset.json; then
            echo "conflicts_found=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "conflicts_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply changeset
        if: steps.conflict-check.outputs.conflicts_found == 'false'
        run: |
          echo "Y" | contentful-merge apply \
            --cma-token "$CONTENTFUL_TOKEN" \
            --space "$SPACE_ID" \
            --environment "$TARGET_ENV" \
            --file changeset.json

      - name: Update master alias
        run: |
          contentful space environment-alias update \
            --space-id "$SPACE_ID" \
            --alias-id "$MASTER_ALIAS" \
            --target-environment-id "$TARGET_ENV" \
            --management-token "$CONTENTFUL_TOKEN"

      - name: Unlock master environment
        if: always()
        run: bash ./scripts/contentful-unlock-master.sh "$SPACE_ID" "$CONTENTFUL_TOKEN"
