name: Contentful CI/CD Automation Workflow

on:
  workflow_dispatch:
    inputs:
      option:
        description: 'Choose operation type (env-clone or alias-update)'
        required: true
        type: choice
        options:
          - env-clone
          - alias-update
      brand:
        description: 'Select brand (Contentful space) to deploy'
        required: true
        type: choice
        options:
          - Dev R&D
          - Fitness First
          - Goodlife Website
          - Gym Website
          - Jetts New Zealand
          - Zap Fitness
      base_env_name:
        description: 'Base environment name prefix (used for clone)'
        required: false
        default: master
      max_env_count:
        description: 'Max allowed environments (used for clone)'
        required: false
        default: 2
      source-env:
        description: 'Source environment (used for alias-update)'
        required: false
        default: 'master-v7'

env:
  CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
  CONTENTFUL_CDA_TOKEN: ${{ secrets.CONTENTFUL_CDA_TOKEN }}
  MASTER_ALIAS: master
  NODE_VERSION: 20

jobs:
  contentful-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Contentful CLI
        run: npm install -g contentful-cli contentful-migration contentful-merge

      - name: Set SPACE_ID based on brand input
        id: set_space
        run: |
          case "${{ github.event.inputs.brand }}" in
            "Fitness First")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_FITNESS_FIRST }}" >> $GITHUB_ENV
              ;;
            "Dev R&D")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID }}" >> $GITHUB_ENV
              ;;
            "Goodlife Website")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_GOODLIFE_WEBSITE }}" >> $GITHUB_ENV
              ;;
            "Gym Website")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_GYM_WEBSITE }}" >> $GITHUB_ENV
              ;;
            "Jetts New Zealand")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_JETTS_NEW_ZEALAND }}" >> $GITHUB_ENV
              ;;
            "Zap Fitness")
              echo "SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID_ZAP_FITNESS }}" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown brand '${{ github.event.inputs.brand }}'"
              exit 1
              ;;
          esac

      ##########################################################
      # OPTION 1: env-clone
      ##########################################################
      - name: Manage and clone environments
        if: ${{ github.event.inputs.option == 'env-clone' }}
        id: manage_envs
        run: |
          echo "üì° Fetching environments for space $SPACE_ID ..."
          base="${{ github.event.inputs.base_env_name }}"
          master_alias="${{ env.MASTER_ALIAS }}"
          max_env=${{ github.event.inputs.max_env_count }}

          # Get current master alias target environment (e.g. master-v7)
          alias_info=$(curl -s \
            -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            "https://api.contentful.com/spaces/$SPACE_ID/environment_aliases/$master_alias")
          current_master_env=$(echo "$alias_info" | jq -r '.environment.sys.id // "unknown"')
          echo "üü¢ Current master alias points to environment: $current_master_env"

          # Export to GitHub Actions env for next step
          echo "CURRENT_MASTER_ENV=$current_master_env" >> $GITHUB_ENV

          # Determine next version
          current_version=$(echo "$current_master_env" | grep -oE '[0-9]+$' || echo "0")
          next_version=$((current_version + 1))
          next_env_name="${base}-v${next_version}"
          echo "üßÆ Next eligible environment name: $next_env_name"

          # Export NEW_ENV
          echo "NEW_ENV=$next_env_name" >> $GITHUB_ENV

          # Fetch all environments
          curl -s \
            -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            "https://api.contentful.com/spaces/$SPACE_ID/environments" \
            > envs_raw.json
          jq '[ .items[] | { name: .name, id: .sys.id, createdAt: .sys.createdAt } ]' envs_raw.json > envs_parsed.json

          # ‚úÖ Check if the next version already exists
          exists=$(jq -r --arg next "$next_env_name" '[ .[] | select(.name == $next) ] | length' envs_parsed.json)
          if (( exists > 0 )); then
            echo "‚ùå Environment '$next_env_name' already exists. Aborting new environment creation."
            exit 1
          fi

          echo "‚úÖ No higher version exists. Proceeding with environment creation."

          # Delete oldest if exceeding max
          env_count=$(jq "[ .[] | select(.name != \"$master_alias\" and (.name | test(\"^${base}-v[0-9]+$\"))) ] | length" envs_parsed.json)
          if (( env_count > max_env )); then
            oldest_env_id=$(jq -r "[ .[] 
              | select(.name != \"$master_alias\" and (.name | test(\"^${base}-v[0-9]+$\"))) ] 
              | sort_by(.createdAt) 
              | .[0].id" envs_parsed.json)
            if [[ -n "$oldest_env_id" && "$oldest_env_id" != "null" ]]; then
              contentful space environment delete \
                --space-id "$SPACE_ID" \
                --environment-id "$oldest_env_id" \
                --management-token "$CONTENTFUL_TOKEN"
            fi
          fi
        env:
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          MASTER_ALIAS: ${{ env.MASTER_ALIAS }}
          SPACE_ID: ${{ env.SPACE_ID }}

      - name: Clone environment
        if: ${{ github.event.inputs.option == 'env-clone' }}
        run: |
          echo "Cloning environment $CURRENT_MASTER_ENV -> $NEW_ENV ..."
          contentful space environment create \
            --space-id "$SPACE_ID" \
            --management-token "$CONTENTFUL_TOKEN" \
            --environment-id "$NEW_ENV" \
            --name "$NEW_ENV" \
            --source-environment "$CURRENT_MASTER_ENV"
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          CURRENT_MASTER_ENV: ${{ env.CURRENT_MASTER_ENV }}
          NEW_ENV: ${{ env.NEW_ENV }}

      # - name: Clone environment
      #   if: ${{ github.event.inputs.option == 'env-clone' }}
      #   run: |
      #     contentful space environment create \
      #       --space-id "$SPACE_ID" \
      #       --management-token "$CONTENTFUL_TOKEN" \
      #       --environment-id "$NEW_ENV" \
      #       --name "$NEW_ENV" \
      #       --source-environment "$MASTER_ALIAS"
      #   env:
      #     SPACE_ID: ${{ env.SPACE_ID }}
      #     CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
      #     MASTER_ALIAS: ${{ env.current_master_env }}
      #     NEW_ENV: ${{ env.NEW_ENV }}
      
      - name: Lock master environment
        if: ${{ github.event.inputs.option == 'env-clone' }}
        run: bash ./scripts/contentful-lock-master.sh "$SPACE_ID" "$CONTENTFUL_TOKEN"
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
      
      - name: Add new env to existing CDA key
        if: ${{ github.event.inputs.option == 'env-clone' }}
        run: |
          echo "Fetching CDA Key ID..."
          CDA_KEY_ID=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            "https://api.contentful.com/spaces/$SPACE_ID/api_keys" \
            | jq -r '.items[] | select(.accessToken=="'${{ secrets.CONTENTFUL_CDA_TOKEN }}'") | .sys.id')

          if [ -z "$CDA_KEY_ID" ] || [ "$CDA_KEY_ID" == "null" ]; then
            echo "Could not find CDA Key ID for token"
            exit 1
          fi

          echo "Found CDA key ID: $CDA_KEY_ID"

          echo "Fetching existing environments for CDA key..."
          CDA_KEY_DETAILS=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            "https://api.contentful.com/spaces/$SPACE_ID/api_keys/$CDA_KEY_ID")

          ENV_LIST=$(echo "$CDA_KEY_DETAILS" | jq '[.environments[].sys.id]')
          VERSION=$(echo "$CDA_KEY_DETAILS" | jq -r '.sys.version')

          echo "Existing environments: $ENV_LIST"
          echo "Current CDA key version: $VERSION"

          UPDATED_ENVS=$(echo "$ENV_LIST" | jq --arg new "$NEW_ENV" \
            '( . // [] ) | if index($new) then . else . + [$new] end')

          PAYLOAD=$(echo "$UPDATED_ENVS" | jq -c '{environments: [.[] | {sys: {type: "Link", linkType: "Environment", id: .}}]}')

          echo "Sending update request to Contentful..."
          RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
            -X PUT \
            -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
            -H "x-contentful-version: $VERSION" \
            -H "Content-Type: application/vnd.contentful.management.v1+json" \
            -d "$PAYLOAD" \
            "https://api.contentful.com/spaces/$SPACE_ID/api_keys/$CDA_KEY_ID")

          echo "HTTP Status: $RESPONSE"
          cat response.json | jq '.' || true

          if [[ "$RESPONSE" -ne 200 ]]; then
            echo "Failed to update CDA key environments. See above response."
            exit 1
          fi

          echo "CDA key updated successfully with new environment: $NEW_ENV"
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          NEW_ENV: ${{ env.NEW_ENV }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          CONTENTFUL_CDA_TOKEN: ${{ secrets.CONTENTFUL_CDA_TOKEN }}

      
      - name: Wait for new environment to be ready
        if: ${{ github.event.inputs.option == 'env-clone' }}
        run: |
          echo "Waiting for environment $NEW_ENV to become ready..."
          for i in {1..30}; do
            status=$(curl -s -H "Authorization: Bearer $CONTENTFUL_TOKEN" \
              "https://api.contentful.com/spaces/$SPACE_ID/environments/$NEW_ENV" | jq -r '.sys.status.sys.id')
            if [[ "$status" == "ready" ]]; then
              echo "Environment $NEW_ENV is ready."
              break
            fi
            echo "Still creating ($status)... waiting 10s..."
            sleep 10
          done

      - name: Run migration scripts
        if: ${{ github.event.inputs.option == 'env-clone' }}
        run: |
          contentful-migration \
            --space-id "$SPACE_ID" \
            --access-token "$CONTENTFUL_TOKEN" \
            --environment-id "$NEW_ENV" \
            --yes \
            Migrations/index.js
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          NEW_ENV: ${{ env.NEW_ENV }}

      - name: Upload roles backup artifact
        if: ${{ github.event.inputs.option == 'env-clone' }}
        uses: actions/upload-artifact@v4
        with:
          name: contentful-roles-backup
          path: ./roles-backup.json
          retention-days: 7

      ##########################################################
      # OPTION 2: alias-update
      ##########################################################
      - name: Download roles backup artifact
        if: ${{ github.event.inputs.option == 'alias-update' }}
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: contentful-new.yml
          name: contentful-roles-backup
          path: .
          run_id: ${{ github.event.inputs.run_id || '' }}
          skip_unavailable_artifacts: true
          if_no_artifact_found: ignore
      
      - name: Fallback to last successful artifact if none found
        if: ${{ github.event.inputs.option == 'alias-update' }}
        run: |
          if [ ! -f "roles-backup.json" ]; then
            echo "No artifact in latest run, fetching from last successful run..."
            latest_success_run=$(gh run list --workflow="contentful-new.yml" --branch=main --json databaseId,status -q '.[] | select(.status==\"success\") | .databaseId' | head -n 1)
            if [ -z "$latest_success_run" ]; then
              echo "‚ùå No successful run found with backup artifact."
              exit 1
            fi
            echo "Found successful run ID: $latest_success_run"
            gh run download "$latest_success_run" --name contentful-roles-backup --dir .
          else
            echo "‚úÖ roles-backup.json found ‚Äî skipping fallback."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch latest target environment
        if: ${{ github.event.inputs.option == 'alias-update' }}
        id: fetch_env
        run: |
          echo "Fetching environments via Contentful API for space $SPACE_ID"

          # Fetch env list
          curl -s \
            -H "Authorization: Bearer ${{ secrets.CONTENTFUL_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.contentful.com/spaces/$SPACE_ID/environments" \
            > envs_raw.json

          # Debug raw response
          echo "Raw response:"
          cat envs_raw.json

          # Guard against empty or error response
          if ! jq -e '.items' envs_raw.json >/dev/null; then
            echo "Error: Invalid response or token invalid"
            exit 1
          fi

          # Extract latest master-vN environment by createdAt
          latest_env=$(jq -r '
            [.items[] 
              | select(.name | test("^master-v[0-9]+$")) 
              | {name: .name, createdAt: .sys.createdAt}] 
            | sort_by(.createdAt) 
            | last 
            | .name
          ' envs_raw.json)

          # Fallback to master if none found
          if [ -z "$latest_env" ] || [ "$latest_env" = "null" ]; then
            echo "No versioned env found, defaulting to master"
            target_env="master"
          else
            target_env="$latest_env"
          fi

          echo "TARGET_ENV=$target_env" >> $GITHUB_ENV
          echo "Resolved TARGET_ENV=$target_env"
        env:
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          SPACE_ID: ${{ env.SPACE_ID }}
      
      - name: Ensure source environment exists
        if: ${{ github.event.inputs.option == 'alias-update' }}
        run: |
          if ! contentful space environment list --space-id "$SPACE_ID" --management-token "$CONTENTFUL_TOKEN" | grep -q "$TARGET_ENV"; then
            echo "Environment $TARGET_ENV does not exist." 
          else
            echo "Environment $TARGET_ENV exists."
          fi
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          TARGET_ENV: ${{ env.TARGET_ENV }}

      - name: Create changeset and check conflicts
        if: ${{ github.event.inputs.option == 'alias-update' }}
        id: conflict-check
        run: |
          contentful-merge create \
            --cda-token "$CONTENTFUL_CDA_TOKEN" \
            --space "$SPACE_ID" \
            --source "${{ github.event.inputs['source-env'] }}" \
            --target "$TARGET_ENV" \
            --output-file changeset.json

          if grep -q '"conflicts":\s*\[' changeset.json && grep -qv '"conflicts":\s*\[\s*\]' changeset.json; then
            echo "conflicts_found=true" >> $GITHUB_OUTPUT
            echo "Conflicts detected!"
            jq '.conflicts' changeset.json
            exit 1
          else
            echo "conflicts_found=false" >> $GITHUB_OUTPUT
          fi
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_CDA_TOKEN: ${{ secrets.CONTENTFUL_CDA_TOKEN }}
          TARGET_ENV: ${{ env.TARGET_ENV }}

      - name: Apply changeset
        if: ${{ github.event.inputs.option == 'alias-update' && steps.conflict-check.outputs.conflicts_found == 'false' }}
        run: |
          echo "Y" | contentful-merge apply \
            --cma-token "$CONTENTFUL_TOKEN" \
            --space "$SPACE_ID" \
            --environment "$TARGET_ENV" \
            --file changeset.json
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          TARGET_ENV: ${{ env.TARGET_ENV }}

      - name: Update master alias
        if: ${{ github.event.inputs.option == 'alias-update' }}
        run: |
          contentful space environment-alias update \
            --space-id "$SPACE_ID" \
            --alias-id "$MASTER_ALIAS" \
            --target-environment-id "$TARGET_ENV" \
            --management-token "$CONTENTFUL_TOKEN"
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          MASTER_ALIAS: ${{ env.MASTER_ALIAS }}
          TARGET_ENV: ${{ env.TARGET_ENV }}

      - name: Unlock master environment
        if: ${{ github.event.inputs.option == 'alias-update' }}
        run: bash ./scripts/contentful-unlock-master.sh "$SPACE_ID" "$CONTENTFUL_TOKEN"
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
      
      - name: Ensure master unlocked on failure
        if: ${{ always() && github.event.inputs.option == 'env-clone' }}
        run: |
          if [ "${{ job.status }}" == "failure" ]; then
            echo "‚ùå Workflow failed ‚Äî attempting to safely unlock master..."

            BACKUP_FILE="roles-backup.json"
            ARTIFACT_NAME="contentful-roles-backup"
            WORKFLOW_FILE="contentful-new.yml"

            if [ ! -f "$BACKUP_FILE" ]; then
              echo "‚ö†Ô∏è Backup file $BACKUP_FILE not found in this run. Fetching from last successful run..."

              latest_success_run=$(gh run list \
                --workflow="$WORKFLOW_FILE" \
                --branch=main \
                --json id,status \
                -q '.[] | select(.status=="success") | .id' | head -n 1)

              if [ -n "$latest_success_run" ]; then
                echo "‚úÖ Found successful run ID: $latest_success_run"
                mkdir -p ./tmp-backup
                gh run download "$latest_success_run" --name "$ARTIFACT_NAME" --dir ./tmp-backup || echo "‚ö†Ô∏è Failed to download artifact"
                if [ -f "./tmp-backup/$BACKUP_FILE" ]; then
                  cp "./tmp-backup/$BACKUP_FILE" ./
                  echo "‚úÖ Successfully restored backup file from previous successful run."
                else
                  echo "‚ùå Backup file $BACKUP_FILE not found in downloaded artifact."
                fi
              else
                echo "‚ùå No successful run found with backup artifact ‚Äî cannot restore roles."
              fi
            else
              echo "‚úÖ Backup file already present in this run."
            fi

            echo "üîì Unlocking master environment..."
            bash ./scripts/contentful-unlock-master.sh "$SPACE_ID" "$CONTENTFUL_TOKEN" || true
            echo "Ensured master environment unlocked."
          else
            echo "Workflow succeeded ‚Äî no unlock needed."
          fi
        env:
          SPACE_ID: ${{ env.SPACE_ID }}
          CONTENTFUL_TOKEN: ${{ secrets.CONTENTFUL_TOKEN }}
          GH_TOKEN: ${{ github.token }}




